<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - RED 2 STYLE</title>
  <link rel="stylesheet" href="admin.css" />
</head>
<body>
  <header>
    <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… RED 2 STYLE</h1>
    <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </header>

  <div class="container">
    <!-- ğŸ§¾ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ -->
    <section id="productForm">
      <h2>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬</h2>
      <form id="addProductForm" onsubmit="return saveProduct(event)">
        <input type="hidden" id="productId" />
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
        <input type="text" id="name" required />

        <label>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬:</label>
        <textarea id="description" rows="3"></textarea>

        <label>Ø§Ù„Ø³Ø¹Ø± (Ø¨Ø§Ù„Ù„ÙŠØ±Ø©):</label>
        <input type="number" id="price" required />

        <label>Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©):</label>
        <input type="text" id="sizes" placeholder="S, M, L, XL" />

        <label>Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø©):</label>
        <input type="text" id="colors" placeholder="Ø£Ø­Ù…Ø±, Ø£Ø³ÙˆØ¯, Ø£Ø¨ÙŠØ¶" />

        <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬:</label>
        <input type="file" id="image" accept="image/*" />

        <label>
          <input type="checkbox" id="featured" />
          Ù…Ù…ÙŠØ² (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
        </label>

        <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
      </form>
    </section>

    <!-- ğŸ“¦ Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <section id="productList">
      <h2>ğŸ“¦ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ØµÙˆØ±Ø©</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„ÙˆØµÙ</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</th>
            <th>Ø§Ù„Ø£Ù„ÙˆØ§Ù†</th>
            <th>Ù…Ù…ÙŠØ²</th>
            <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
          </tr>
        </thead>
        <tbody id="productsTable"></tbody>
      </table>
    </section>
  </div>

  <script type="module">
    // ğŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
    const SUPABASE_URL = "https://qbkkdsmhnmmrzsdewhde.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFia2tkc21obm1tcnpzZGV3aGRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MjQzMTIsImV4cCI6MjA3NTEwMDMxMn0.opDK0TlCbfCNlLpvMWFxM79myJkgUCIbufw1pbw8bP0";

    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // ğŸ“¤ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬
    async function saveProduct(e) {
      e.preventDefault();
      const id = document.getElementById("productId").value;
      const name = document.getElementById("name").value;
      const description = document.getElementById("description").value;
      const price = parseFloat(document.getElementById("price").value);
      const sizes = document.getElementById("sizes").value;
      const colors = document.getElementById("colors").value;
      const featured = document.getElementById("featured").checked;
      const imageFile = document.getElementById("image").files[0];

      let imageUrl = null;

      if (imageFile) {
        const fileName = `${Date.now()}-${imageFile.name}`;
        const { data: uploadData, error: uploadError } = await supabase
          .storage.from("products-images")
          .upload(fileName, imageFile);

        if (uploadError) {
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
          return;
        }

        imageUrl = `${SUPABASE_URL}/storage/v1/object/public/products-images/${fileName}`;
      }

      const productData = {
        name,
        description,
        price,
        sizes,
        colors,
        featured,
        ...(imageUrl && { image_url: imageUrl }),
      };

      let result;
      if (id) {
        result = await supabase.from("products").update(productData).eq("id", id);
      } else {
        result = await supabase.from("products").insert([productData]);
      }

      if (result.error) {
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬");
        console.log(result.error);
      } else {
        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
        document.getElementById("addProductForm").reset();
        document.getElementById("productId").value = "";
        loadProducts();
      }
    }

    // ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    async function loadProducts() {
      const { data, error } = await supabase.from("products").select("*").order("id", { ascending: false });
      if (error) return console.error(error);

      const tbody = document.getElementById("productsTable");
      tbody.innerHTML = "";
      data.forEach((p) => {
        tbody.innerHTML += `
          <tr>
            <td><img src="${p.image_url || ''}" /></td>
            <td>${p.name}</td>
            <td>${p.description || ''}</td>
            <td>${p.price} Ù„.Ø³</td>
            <td>${p.sizes || '-'}</td>
            <td>${p.colors || '-'}</td>
            <td>${p.featured ? "â­" : "â€”"}</td>
            <td>
              <button onclick="editProduct(${p.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
              <button onclick="deleteProduct(${p.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </td>
          </tr>
        `;
      });
    }

    // âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
    window.editProduct = async function (id) {
      const { data } = await supabase.from("products").select("*").eq("id", id).single();
      if (!data) return;
      document.getElementById("productId").value = data.id;
      document.getElementById("name").value = data.name;
      document.getElementById("description").value = data.description;
      document.getElementById("price").value = data.price;
      document.getElementById("sizes").value = data.sizes;
      document.getElementById("colors").value = data.colors;
      document.getElementById("featured").checked = data.featured;
    };

    // ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬
    window.deleteProduct = async function (id) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
      const { error } = await supabase.from("products").delete().eq("id", id);
      if (!error) loadProducts();
    };

    // ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    window.logout = function () {
      window.location.href = "index.html";
    };

    loadProducts();
  </script>
</body>
</html>
